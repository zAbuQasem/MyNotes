# IMAP & SMTP injection
---
An IMAP/SMTP Injection makes it possible to **access** a mail server which otherwise would not be directly accessible from the Internet. In some cases, these internal systems do not have the same level of infrastructure security and hardening that is applied to the front-end web servers.

![smtp](../../assets/WebPentesting/WebVulns/smtp.png)

Some examples of attacks using the IMAP/SMTP Injection technique are:

-   Exploitation of vulnerabilities in the IMAP/SMTP protocol
-   Application restrictions evasion
-   Anti-automation process evasion
-   Information leaks
-   Relay/SPAM

## Identifying Vulnerable Parameters
### IMAP special parameters that should be used are:

![imap](../../assets/WebPentesting/WebVulns/imap.png)

In this example, the “mailbox” parameter is being tested by manipulating all requests with the parameter in:
```txt
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46106&startMessage=1
```
The following examples can be used.
- Assign a null value to the parameter.
- Substitute the value with a random value.
- Add other values to the parameter.
- Add non standard special characters (i.e.: `\`, `'`, `"`, `@`, `#`, `!`, `|`).
-   Eliminate the parameter.
Examples:
```txt
1- http://<webmail>/src/read_body.php?mailbox=&passed_id=46106&startMessage=1

2- http://<webmail>/src/read_body.php?mailbox=NOTEXIST&passed_id=46106&startMessage=1

3- http://<webmail>/src/read_body.php?mailbox=INBOX PARAMETER2&passed_id=46106&startMessage=1

4- http://<webmail>/src/read_body.php?mailbox=INBOX"&passed_id=46106&startMessage=1

5- http://<webmail>/src/read_body.php?passed_id=46106&startMessage=1
```
The final result of the above testing gives the tester three possible situations:
- **S1** - The application returns a error code/message *(Successful injection)*
- **S2** - The  application does not return an error code/message, but it does not realize the requested operation  *(Successful injection - harder and must use blind)*
- **S3** - The application does not return an error code/message and realizes the operation requested normally

**Error example**
```txt
ERROR: Bad or malformed request.
Query: SELECT "INBOX""
Server responded: Unexpected extra arguments to Select
```

> For more details on exploitation: https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/10-Testing_for_IMAP_SMTP_Injection

### Whitepapers

-   [RFC 0821 “Simple Mail Transfer Protocol”](https://tools.ietf.org/html/rfc821)
-   [RFC 3501 “Internet Message Access Protocol - Version 4rev1”](https://tools.ietf.org/html/rfc3501)
-   [Vicente Aguilera Díaz: “MX Injection: Capturing and Exploiting Hidden Mail Servers”](http://www.webappsec.org/projects/articles/121106.pdf)